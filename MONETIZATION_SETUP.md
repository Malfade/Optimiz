# Настройка системы монетизации для бота оптимизации Windows

## Обзор

Данный документ описывает процесс настройки и использования системы монетизации, интегрированной с ботом оптимизации Windows. Система монетизации позволяет:

1. Принимать платежи от пользователей через ЮKassa
2. Управлять подписками пользователей
3. Ограничивать доступ к функциям бота для пользователей без активной подписки

## Компоненты системы

Система монетизации состоит из следующих компонентов:

1. **Сервер монетизации** - веб-приложение на Node.js для обработки платежей через ЮKassa
2. **Модуль подписок** (`subscription_check.py`) - модуль для проверки и управления подписками пользователей
3. **Webhook-обработчик** (`webhook_handler.py`) - Flask-приложение для обработки уведомлений о платежах
4. **Интеграция с ботом** - проверка подписки перед выполнением команд

## Установка и настройка

### 1. Настройка сервера монетизации

#### Зависимости
- Node.js 18+ 
- npm 

#### Установка
```bash
# Клонирование репозитория с сервером монетизации
git clone https://github.com/yourusername/monetization-server.git
cd monetization-server

# Установка зависимостей
npm install
```

#### Настройка ЮKassa
1. Создайте аккаунт на [ЮKassa](https://yookassa.ru/)
2. Создайте магазин и получите `shopId` и `secretKey`
3. Обновите эти данные в файле `server.js`:

```javascript
const shopId = 'YOUR_SHOP_ID';
const secretKey = 'YOUR_SECRET_KEY';
```

#### Запуск сервера монетизации
```bash
# Запуск в режиме разработки
npm run dev

# Запуск в производственном режиме
npm start
```

### 2. Настройка модуля подписок

Модуль подписок (`subscription_check.py`) уже интегрирован в бота. Вам необходимо только обновить URL сервера монетизации:

```python
# Путь к файлу с данными о подписках пользователей
SUBSCRIPTIONS_FILE = Path(os.path.dirname(os.path.abspath(__file__))) / "subscriptions.json"

# URL сервера монетизации
MONETIZATION_SERVER_URL = "http://your-server-domain:3001"  # Замените на фактический URL вашего сервера
```

### 3. Настройка webhook-обработчика

#### Зависимости
- Python 3.9+
- Flask

#### Запуск webhook-обработчика
```bash
# Установка переменных окружения
export WEBHOOK_SECRET="your_secret_key_here"
export ADMIN_API_KEY="your_admin_api_key_here"
export PORT=5000

# Запуск webhook-обработчика
python webhook_handler.py
```

#### Настройка вебхуков в ЮKassa
1. В личном кабинете ЮKassa настройте URL для вебхуков: `https://your-domain.com/webhook/payment`
2. Настройте подпись вебхуков с использованием того же секретного ключа, который указан в `WEBHOOK_SECRET`

### 4. Интеграция с ботом оптимизации

Интеграция уже выполнена в файлах `main.py` и `optimization_bot.py`. Убедитесь, что у вас включена проверка подписки:

```python
# В файле main.py
SUBSCRIPTION_CHECK_ENABLED = os.getenv("SUBSCRIPTION_CHECK_ENABLED", "true").lower() == "true"
```

## Использование системы монетизации

### Проверка статуса подписки в боте

Пользователи могут проверить статус своей подписки с помощью команды `/subscription`. Бот покажет следующую информацию:
- Статус подписки (активна/неактивна)
- Тип плана (базовый, стандартный, премиум)
- Дата активации
- Дата окончания
- Количество оставшихся дней

### Оплата подписки

1. Пользователь получает ссылку на мини-приложение оплаты при использовании команды `/subscription`
2. Пользователь выбирает план подписки и оплачивает его через ЮKassa
3. После успешной оплаты, сервер монетизации отправляет вебхук на webhook-обработчик
4. Webhook-обработчик активирует подписку для пользователя
5. Пользователь получает доступ к функциям бота

### Добавление подписки вручную (для администраторов)

Администраторы могут добавлять подписки вручную с помощью API:

```bash
curl -X POST "https://your-domain.com/api/add-subscription" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "123456789",
    "plan_name": "premium",
    "duration_days": 90,
    "api_key": "your_admin_api_key_here"
  }'
```

## Структура файлов и их назначение

- `server.js` - основной файл сервера монетизации
- `subscription_check.py` - модуль для проверки и управления подписками
- `webhook_handler.py` - обработчик вебхуков от платежной системы
- `main.py` - основной файл бота с интеграцией проверки подписки
- `optimization_bot.py` - модуль бота с добавленными проверками подписки
- `subscriptions.json` - файл для хранения данных о подписках

## Устранение неполадок

### Проблемы с платежами
1. Проверьте правильность настройки ЮKassa
2. Убедитесь, что сервер монетизации доступен
3. Проверьте журналы сервера монетизации: `npm run logs`

### Проблемы с подписками
1. Проверьте файл `subscriptions.json`
2. Проверьте журналы webhook-обработчика: `webhook.log`
3. Используйте API для проверки статуса подписки: `https://your-domain.com/api/check-subscription/USER_ID`

## Планы подписок

По умолчанию доступны следующие планы подписок:

1. **Базовый (basic)** - 30 дней, базовый функционал
2. **Стандартный (standard)** - 30 дней, полный функционал
3. **Премиум (premium)** - 90 дней, полный функционал со скидкой

Вы можете изменить планы подписок в файле `webhook_handler.py`:

```python
SUBSCRIPTION_PLANS = {
    'basic': 30,       # Базовый план на 1 месяц
    'standard': 30,    # Стандартный план на 1 месяц
    'premium': 90      # Премиум план на 3 месяца
}
``` 