# Инструкции по перезапуску сервиса в Railway

## Что было изменено

1. **Комплексная система работы с Anthropic API**:
   - Создан файл `fallback_anthropic.py` с минимальной реализацией клиента Anthropic без зависимостей
   - Добавлен файл `anthropic_wrapper.py` с обработкой прокси
   - Обновлен `fix_railway_anthropic.py` для перехвата импорта модуля anthropic и устранения проблемы с proxies
   - Полностью переработан `main.py` для последовательного пробования разных методов инициализации клиента

2. **Стратегия инициализации**:
   - Очистка переменных окружения HTTP_PROXY и HTTPS_PROXY 
   - Последовательная попытка использования разных имплементаций клиента
   - Подробное логирование для отслеживания процесса инициализации

## Шаги для перезапуска

1. **Загрузите измененные файлы в репозиторий**:
   - `main.py` (новая версия с улучшенной системой инициализации)
   - `fix_railway_anthropic.py` (новый патч для Railway)
   - `anthropic_wrapper.py` (новая обертка для решения проблем с прокси)
   - `fallback_anthropic.py` (минимальная реализация клиента Anthropic)
   - Убедитесь, что `Procfile` содержит команду `worker: python main.py`

2. **Перезапустите сервис в Railway**:
   - Зайдите в панель управления Railway
   - Найдите ваш проект и откройте вкладку Deployments
   - Нажмите на текущий деплой
   - Нажмите кнопку "Redeploy" в правом верхнем углу
   - Следите за логами процесса сборки и запуска

3. **Проверка логов**:
   - После перезапуска сервиса внимательно изучите логи
   - Ищите сообщения вида:
     ```
     INFO:main:Успешно импортирован: fallback_anthropic, версия: unknown
     INFO:optimization_bot:Бот оптимизации Windows запущен!
     ```
   - Или любые сообщения об инициализации клиента:
     ```
     INFO:safe_anthropic:Успешно инициализирован Anthropic
     ```
   - Или 
     ```
     INFO:main:✅ Тестовый клиент fallback_anthropic успешно создан!
     ```

## Проверка работоспособности

1. **Базовая проверка**:
   - Напишите боту `/start` или `/help`
   - Убедитесь, что бот отвечает на команды

2. **Проверка работы с Claude**:
   - Отправьте скриншот рабочего стола
   - Бот должен начать анализ скриншота и генерацию скрипта оптимизации
   - В логах должны быть сообщения об успешной работе с API Claude

## Дополнительные примечания

1. **Версия библиотеки anthropic**:
   - Если проблемы продолжаются, рассмотрите следующие варианты:
     - Убедитесь, что в `requirements.txt` указана версия `anthropic==0.19.1`
     - Или используйте более старую версию `anthropic==0.5.0`

2. **Что делать, если ничего не работает**:
   - Проверьте log-файлы, чтобы понять, на каком этапе происходит ошибка
   - Возможно, достаточно указать другую версию библиотеки anthropic в requirements.txt
   - При необходимости отключите все патчи и используйте резервную реализацию из fallback_anthropic.py 